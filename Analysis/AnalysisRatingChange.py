import sys
sys.path.insert(0, "..")

import json
from UISimulation.PpdUISimulationRequest import PpdUISimulationRequest
from Open.PpdOpenClient import PpdOpenClient
import pandas as pd
from pandas import DataFrame
import datetime

def analysis_rating_chagne():
    # localStorage.removeItem("ppdItem")
    # t = localStorage.getItem("ppdItem") || "[]"; t = JSON.parse(t); $.each($(".listingId"), (key, value) => t.push(parseInt($(value).text()))); localStorage.setItem("ppdItem", JSON.stringify(t)); t

    file_name = "RatingChange.csv"
    # file_name = "RatingChange_overDue.csv"
    df_file = pd.read_csv(file_name)

    with open("RatingChange.txt", "r") as f:
        t = f.readlines()
        listing_ids = [int(item.strip()) for item in t]

    print(len(listing_ids), listing_ids)

    cookies = "gr_user_id=11f8ea81-90aa-4c3e-a041-71c51c28ea51; uniqueid=747711b0-faee-473f-96e7-a488248ded5f; __fp=fp; __vid=3407234.1530775507276; _ppdaiWaterMark=15312861763999; _ga=GA1.2.1098278737.1530780657; ppdaiRole=8; openid=cdda7ce1e0bcfdaa2503c4f0770aabe4; ppd_uname=pdu8953799660; regSourceId=0; referID=0; fromUrl=https%3A%2F%2Fwww.ppdai.com%2Fmoneyhistory; referDate=2018-10-8%2010%3A44%3A40; sensorsdata2015jssdkcross=%7B%22distinct_id%22%3A%22pdu8953799660%22%2C%22%24device_id%22%3A%221646959503432e-09fcbfb7c16c45-5b193613-2304000-16469595035ae%22%2C%22first_id%22%3A%221646959503432e-09fcbfb7c16c45-5b193613-2304000-16469595035ae%22%2C%22props%22%3A%7B%22%24latest_traffic_source_type%22%3A%22%E7%9B%B4%E6%8E%A5%E6%B5%81%E9%87%8F%22%2C%22%24latest_referrer%22%3A%22%22%2C%22%24latest_referrer_host%22%3A%22%22%2C%22%24latest_search_keyword%22%3A%22%E6%9C%AA%E5%8F%96%E5%88%B0%E5%80%BC(%E7%9B%B4%E6%8E%A5%E6%89%93%E5%BC%80)%22%7D%7D; token=7cddd068594dfea0e1aa6a7ef7093f57ee79fa9d6e9794d11b3fccbc93ade9d562e9cc5d2585d06db2; __eui=Cel3wwogQQUMvl7O%2BveuJQ%3D%3D; __tsid=262473610; aliyungf_tc=AQAAAG4qv2/EfwMAjlD3PL+lxOxQtKu6; Hm_lvt_f87746aec9be6bea7b822885a351b00f=1539574208,1539743508; __utmc=1; __utma=1.1098278737.1530780657.1539940133.1539942197.46; __utmz=1.1539942197.46.46.utmcsr=ppdai.com|utmccn=(referral)|utmcmd=referral|utmcct=/moneyhistory; registerurl=https%3A%2F%2Fpay.ppdai.com%2Fdeposit%2Fprocessing%3Ftradeid%3D181019064000205765; registersourceurl=https%3A%2F%2Fppdai.cloud.cmbchina.com%2Frecharge%3Fsecret%3Dwkjvr1odfzlqdfpz06z9lgoojsththzvnn9ac1t9etixueafhdzicst1fm0hu8ewnja4nejsmjz9fcyg6c7m0y1bfsuxhadljspmatobblinsuoacfpgrecs2ymi1nwibkdtyywq67dysqjb01vuezai0tphgtqgzcfxveyubyhxfcm2yf8jlve3o8g0lx7kt0fil7vcmtkxr7%252fw4sp2grk3w6waaztcm8joqwavbyze%252fnzjlptakr6yaf6ukzt%252bja2l5qvxku%252bafhbtartpqdkditajdrkleil7mhlqicvezlrkcavybcldl7ofzy8%252fpdps4pqwgcxvgjn3tnx9aqxy0uo2%252fz24mfeqmo3pehbrz55bofdybu%252bs2jp1xtglu2%252facrf8i7o2ec2%252b%252bigaezq295lxbtsl024pvhmh44aeysvm4dpcytukbep1l%252bj%252bhtlumd2c%252fireqe9vh9zb6oafakg4gxvwobnkgcifbkynn3oo%252fpg83talpeteqtsofhqir1g1%252bbfujlcdnzcgcphllloa%252bke6yfxxdvzpy2fd6wc%252f8dhhs9%252fsvrhxoqwgx7v6q5djz8bdgz4notwqjtvutezeeo2hh0pjt0cou2ksroshaw7d659cgid0sq9l%252biwmv6cs0fth7tagld8a2plf2c4g1hz85vx7sfh2lea%253d; Hm_lvt_aab1030ecb68cd7b5c613bd7a5127a40=1539940132,1539940159,1539940326,1539942229; Hm_lpvt_aab1030ecb68cd7b5c613bd7a5127a40=1539942234; __vsr=1539743507367.src%3Ddirect%7Cmd%3Ddirect%7Ccn%3Ddirect%3B1540176469202.refSite%3Dhttps%3A//pay.ppdai.com/deposit/inpoursuccess/withhold%7Cmd%3Dreferral%7Ccn%3Dreferral%3B1540183782829.src%3Ddirect%7Cmd%3Ddirect%7Ccn%3Ddirect%3B1540262365101.refSite%3Dhttps%3A//invstrat.ppdai.com/strategyMarket%7Cmd%3Dreferral%7Ccn%3Dreferral%3B1540265859551.src%3Ddirect%7Cmd%3Ddirect%7Ccn%3Ddirect; gr_session_id_b9598a05ad0393b9=f671e93e-4cc8-4514-be91-4a276192badd; gr_session_id_b9598a05ad0393b9_f671e93e-4cc8-4514-be91-4a276192badd=true; currentUrl=https%3A%2F%2Finvdebt.ppdai.com%2Fnegotiable%2Fapply%3Fowingnumber%3D%26sort%3D7%26level%3D%2Cb%2C%26dueday%3D%26minprincipal%3D%26maxprincipal%3D%26rate%3D%26pageindex%3D2; Hm_lpvt_f87746aec9be6bea7b822885a351b00f=1540275683; __sid=1540274122165.15.1540275683427; waterMarkTimeCheck1=10%2F23%2F2018+14%3A21%3A24"
    client = PpdUISimulationRequest(cookies=cookies)

    json_data_str = client.pre_apply_list(listing_ids)
    # json_data_str = '{"code":1,"data":{"applyDebtList":[{"allowanceRadio":0.00,"currentCreditCode":"C","listingId":125979520,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":10.24,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"C","listingId":125983680,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.68,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"B","listingId":122503182,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":17.21,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"E","listingId":125995511,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.68,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"C","listingId":126003947,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.68,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"C","listingId":126004116,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.68,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"C","listingId":126004829,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.68,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"C","listingId":126004666,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.68,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"E","listingId":126004744,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.68,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"D","listingId":126005308,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.68,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"C","listingId":126007228,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.68,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"C","listingId":126007630,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.68,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"C","listingId":126008339,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.68,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"C","listingId":126009029,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.68,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"C","listingId":126010086,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.68,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"C","listingId":126010412,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.68,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"E","listingId":126012704,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.68,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"C","listingId":126016036,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.69,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"C","listingId":126016934,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.68,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"C","listingId":126017932,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.68,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"C","listingId":126019718,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.68,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"C","listingId":126024449,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.68,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"E","listingId":126026597,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.68,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"C","listingId":126026349,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.68,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"C","listingId":126030068,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.68,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"B","listingId":122628902,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":17.21,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"D","listingId":126034393,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.68,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"C","listingId":126035461,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.68,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"C","listingId":126038768,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.68,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"C","listingId":126042159,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.68,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"C","listingId":126042356,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.68,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"B","listingId":122663631,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":17.21,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"C","listingId":126064996,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.68,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"E","listingId":126072113,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.66,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"C","listingId":126084379,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.66,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"D","listingId":126084346,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.66,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"C","listingId":126084471,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.66,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"C","listingId":126084590,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.66,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"C","listingId":126084708,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.66,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"C","listingId":126085087,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.66,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"C","listingId":126086039,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.66,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"C","listingId":126086217,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.66,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"F","listingId":126086200,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.66,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"C","listingId":126086833,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.66,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"C","listingId":126086975,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.66,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"C","listingId":126087351,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.66,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"C","listingId":126087249,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.66,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"C","listingId":126087954,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.66,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"C","listingId":126089558,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.66,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"C","listingId":126090318,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.66,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"C","listingId":126089939,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.66,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"C","listingId":126092449,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.66,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"B","listingId":122731209,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":17.20,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"B","listingId":122753505,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":17.20,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"B","listingId":122768999,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":17.20,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"B","listingId":122777591,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":17.20,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"B","listingId":122786123,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":17.20,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"C","listingId":126156251,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.66,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"B","listingId":122815327,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":17.19,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"C","listingId":126181116,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.63,"priceforsaleRate":20.00}],"rateMaxMultiples":20.00,"rateMinMultiples":0.00,"sumAllowanceRadio":0.00,"sumFee":11.36,"sumOwingAmount":2263.14,"sumPriceforsale":2298.62},"netCode":1}'

    # 当前逾期
    # {"code":1,"data":{"applyDebtList":[{"allowanceRadio":0.00,"currentCreditCode":"G","listingId":125257334,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":42.72,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"C","listingId":121727301,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":17.22,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"C","listingId":128608088,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":50.85,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"C","listingId":128493838,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":50.88,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"B","listingId":121611281,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":17.23,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"C","listingId":121463781,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":17.24,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"B","listingId":121514001,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":17.24,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"B","listingId":121372383,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":17.25,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"C","listingId":121365243,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":17.25,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"B","listingId":121401675,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":34.53,"priceforsaleRate":20.00},{"allowanceRadio":0.00,"currentCreditCode":"E","listingId":120974900,"maxRate":40.00,"minRate":20.00,"preDebtDealId":0,"priceforsale":17.28,"priceforsaleRate":20.00}],"rateMaxMultiples":20.00,"rateMinMultiples":0.00,"sumAllowanceRadio":0.00,"sumFee":1.51,"sumOwingAmount":294.55,"sumPriceforsale":299.69},"netCode":1}
    print(json_data_str)
    json_data = json.loads(json_data_str)

    count = 0

    datas = []

    for item in json_data["data"]["applyDebtList"]:
        if item["currentCreditCode"] in ["C", "D", "E", "F", "G"]:
            print(item["listingId"], "Changed to", item["currentCreditCode"], item["priceforsale"])
            count += 1
        item["origin"] = "B"
        item["testDate"] = datetime.datetime.today().strftime('%Y-%m-%d')
        datas.append(item)

    df = DataFrame(datas)
    df = pd.concat([df_file, df], ignore_index=True, sort=False)
    df.to_csv(file_name, index=False)
    print(count)

def main():
    analysis_rating_chagne()

    # open_client = PpdOpenClient(key_index=1)
    # open_client.batch_get_listing_info([])
    pass

if __name__ == "__main__":
    main()